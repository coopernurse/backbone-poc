var Barrister;Barrister||(Barrister={}),function(){function b(b){var c="",d;for(d=0;d<b;d++){var e=Math.floor(Math.random()*a.length);c+=a.substring(e,e+1)}return c}function e(a,b){if(a){var e=JSON.stringify(a);return e?b?e:e.replace(c,d):e}return a}function f(a,c){var d={jsonrpc:"2.0",id:b(20),method:a};return c!==null&&c!==undefined&&(d.params=c),d}function g(a,b,c,d){return a=a||null,{jsonrpc:"2.0",id:a,error:{code:b,message:c,data:d}}}function h(a,b,c){var d;if(b)d=g(a.id,-32e3,b);else if(c!==undefined&&c!==null)if(typeof c=="object")d=c;else try{d=JSON.parse(c)}catch(e){d=g(a.id,-32700,"Unable to parse response JSON: "+c)}else d=g(a.id,-32603,"Null response body received from server");return d}function i(a){var b,c,d,e;this.idl=a,this.interfaces={},this.functions={},this.structs={},this.enums={},this.meta={};for(b=0;b<a.length;b++){d=a[b];if(d.type==="interface"){this.interfaces[d.name]=d;for(c=0;c<d.functions.length;c++)e=d.functions[c],this.functions[d.name+"."+e.name]=e}else if(d.type==="struct")this.structs[d.name]=d;else if(d.type==="enum")this.enums[d.name]=d;else if(d.type==="meta")for(c in d)d.hasOwnProperty(c)&&c!=="type"&&(this.meta[c]=d[c])}}function j(a){this.client=a,this.reqList=[]}function k(a){this.transport=a,this.trace=null,this.validateRequest=!0}var a="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",c=new RegExp("[\\u007f-\\uffff]","g"),d=function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)};i.prototype.validate=function(a,b,c,d){var e=this,f,g,h,i,j,k,l=[!0,null];a=a||"";if(d===null||d===undefined)return b.optional===!0?l:[!1,a+" cannot be null"];var m=typeof d;if(c===!0){if(m!=="object"||!d instanceof Array)return e.validationErr(a,"[]"+b.type,m,d);for(f=0;f<d.length;f++){j=e.validate(a+"["+f+"]",b,!1,d[f]);if(!j[0])return j}return l}if(b.type==="string")return m==="string"?l:e.validationErr(a,b.type,m,d);if(b.type==="bool")return m==="boolean"?l:e.validationErr(a,b.type,m,d);if(b.type==="int"||b.type==="float"){if(m!=="number")return e.validationErr(a,b.type,m,d);if(b.type==="int"){k=d===+d&&d===(d|0);if(!k)return e.validationErr(a,b.type,"float",d)}return l}if(e.structs[b.type]){if(m!=="object")return e.validationErr(a,b.type,m,d);h=e.getAllStructFields([],e.structs[b.type]),i={};for(f=0;f<h.length;f++){g=h[f],j=e.validate(a+"."+g.name,g,g.is_array,d[g.name]);if(!j[0])return j;i[g.name]=1}for(f in d)if(d.hasOwnProperty(f)&&!i[f])return[!1,a+"."+g.name+" does not exist in type '"+b.type+"'"];return l}if(e.enums[b.type]){if(m!=="string")return e.validationErr(a,b.type,m,d);g=e.enums[b.type];for(f=0;f<g.values.length;f++)if(g.values[f].value===d)return l;var n=a+" value '"+d+"' is not in the enum '"+g.name+"': "+JSON.stringify(g.values);return[!1,n]}return[!1,a+" unknown type: "+b.type]},i.prototype.validateReq=function(a){if(a.method==="barrister-idl")return null;var b=this.functions[a.method];if(!b)return g(a.id,-32601,"Method not found: "+a.method);var c=a.params?a.params.length:0,d,e,f;if(c!==b.params.length)return f="Param length: "+c+" != expected length: "+b.params.length,g(a.id,-32602,f);for(d=0;d<b.params.length;d++){e=this.validate(b.params[d].name,b.params[d],b.params[d].is_array,a.params[d]);if(!e[0])return f="Invalid request param["+d+"]: "+e[1],g(a.id,-32602,f)}return null},i.prototype.validateResp=function(a,b){if(!b.result||a.method==="barrister-idl")return b;var c=this.functions[a.method];if(!c)return g(a.id,-32601,"Method not found: "+a.method);var d=this.validate("",c.returns,c.returns.is_array,b.result);if(!d[0]){var e="Invalid response for "+a.method+": "+d[1];return console.log("ERROR: "+e),g(a.id,-32001,e)}return b},i.prototype.getAllStructFields=function(a,b){return b.fields.length>0&&(a=a.concat(b.fields)),b["extends"]?this.getAllStructFields(a,this.structs[b["extends"]]):a},i.prototype.validationErr=function(a,b,c,d){return[!1,a+" expects type '"+b+"' but got type '"+c+"' for value: "+d]},j.prototype.proxy=function(a){var b=this;return b.client._proxy(function(a){return b._functionProxy(a)},a)},j.prototype.request=function(a,b){this.reqList.push(f(a,b))},j.prototype._functionProxy=function(a){var b=this;return function(){var c=Array.prototype.slice.call(arguments);b.request(a,c)}},j.prototype.send=function(a){var b=this,c,d,e,f={},h=[];for(c=0;c<b.reqList.length;c++)d=b.reqList[c],b.client.validateRequest?(e=b.client.contract.validateReq(d),e?f[d.id]=e:h.push(d)):h.push(d);var i=function(a,e){var f=[],h;for(c=0;c<a.length;c++)a[c].id&&(d=e[a[c].id],d?(d=b.wrapResp(a[c],d),d.error?h={error:d.error}:h={result:d.result}):(msg="No response received for request id: "+a[c].id,h={error:b.wrapResp(a[c],g(-32603,msg))}),f.push(b.wrapResp(a[c],h)));return f};if(h.length===0){a(null,i(b.reqList,f));return}b.client._send(h,function(c){if(c!==null&&c!==undefined&&c instanceof Array){var d=[],e,g,h;for(e=0;e<c.length;e++)g=c[e],g.id&&(f[g.id]=g);a(null,i(b.reqList,f))}else a(c,null)})},j.prototype.wrapResp=function(a,b){return b.method=a.method,b.params=a.params,b},k.prototype.loadContract=function(a){var b=this;b.request("barrister-idl",[],function(c,d){c?a(c):(b.contract=new i(d),a())})},k.prototype.getMeta=function(){return this.contract.meta},k.prototype.enableTrace=function(a){a&&typeof a=="function"?this.trace=a:this.trace=function(a){console.log(a)}},k.prototype.disableTrace=function(){this.trace=null},k.prototype.startBatch=function(){return new j(this)},k.prototype.proxy=function(a){var b=this;return b._proxy(function(a){return b._functionProxy(a)},a)},k.prototype._proxy=function(a,b){var c=this;if(!c.contract)throw"Contract.loadContract() has not been called yet!";var d=c.contract.interfaces[b];if(d){var e={},f,g;for(f=0;f<d.functions.length;f++)g=d.functions[f],e[g.name]=a(b+"."+g.name);return e}throw"Interface not found: "+b},k.prototype._functionProxy=function(a){var b=this;return function(){var c=Array.prototype.slice.call(arguments),d=c.pop();if(d===undefined||d===null||typeof d!="function")throw"Last arg to "+a+" must be a callback function!";b.request(a,c,d)}},k.prototype.request=function(a,b,c){var d=this,e=f(a,b);if(d.validateRequest&&d.contract){var g=d.contract.validateReq(e);if(g){c(g.error,null);return}}d._send(e,function(a){a.error?c(a.error,null):c(null,a.result)})},k.prototype._send=function(a,b){var c=this;c.trace&&c.trace("Request: "+e(a)),c.transport(a,function(a){c.trace&&c.trace("Response: "+e(a)),b(a)})};var l=function(a){var b=a;return typeof a=="string"&&(b=function(b,c){var d={type:"POST",contentType:"application/json",data:e(b),converters:{"text json":function(a){return h(b,null,a)}},error:function(a,d,e){c(h(b,d+" "+e,null))},success:function(a,d,e){c(h(b,null,a))}};jQuery.ajax(a,d)}),new k(b)};Barrister.httpClient=l,Barrister.parseResponse=h,Barrister.Client=k,Barrister.Contract=i,Barrister.JSON_stringify=e}();